<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreshKeep - Dashboard Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .btn-header {
            padding: 12px 24px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
        }

        .btn-header:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2.5em;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #666;
            font-size: 0.95em;
            font-weight: 600;
        }

        .stat-card.warning h3 {
            color: #ffc107;
        }

        .stat-card.danger h3 {
            color: #dc3545;
        }

        .stat-card.success h3 {
            color: #28a745;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .chart-card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .expiring-list {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .expiring-list h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .expiring-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border-left: 5px solid #ffc107;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .expiring-item.critical {
            border-left-color: #dc3545;
            background: #ffe0e0;
        }

        .expiring-item h3 {
            color: #333;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .expiring-item p {
            color: #666;
            font-size: 0.9em;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #ffe0e0;
            color: #d32f2f;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Dashboard Analytics</h1>
            <div class="header-actions">
                <a href="index.html" class="btn-header">üè† Inventario</a>
                <button onclick="logout()" class="btn-header">üö™ Salir</button>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Cargando datos del dashboard...</p>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <div id="dashboard" style="display: none;">
            <!-- Estad√≠sticas Principales -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalProducts">0</h3>
                    <p>Productos Activos</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalValue">0‚Ç¨</h3>
                    <p>Valor del Inventario</p>
                </div>
                <div class="stat-card warning">
                    <h3 id="expiringSoon">0</h3>
                    <p>Caducan Pronto</p>
                </div>
                <div class="stat-card danger">
                    <h3 id="expired">0</h3>
                    <p>Caducados</p>
                </div>
                <div class="stat-card success">
                    <h3 id="consumed">0</h3>
                    <p>Consumidos (30d)</p>
                </div>
                <div class="stat-card danger">
                    <h3 id="wasteRate">0%</h3>
                    <p>Tasa de Desperdicio</p>
                </div>
            </div>

            <!-- Productos Pr√≥ximos a Caducar -->
            <div class="expiring-list">
                <h2>‚ö†Ô∏è Productos Pr√≥ximos a Caducar</h2>
                <div id="expiringProducts"></div>
            </div>

            <!-- Gr√°ficos -->
            <div class="charts-grid">
                <!-- Distribuci√≥n por Categor√≠as -->
                <div class="chart-card">
                    <h2>üì¶ Distribuci√≥n por Categor√≠as</h2>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <!-- Distribuci√≥n por Ubicaci√≥n -->
                <div class="chart-card">
                    <h2>üìç Distribuci√≥n por Ubicaci√≥n</h2>
                    <div class="chart-container">
                        <canvas id="locationChart"></canvas>
                    </div>
                </div>

                <!-- Tendencias Diarias -->
                <div class="chart-card" style="grid-column: 1 / -1;">
                    <h2>üìà Tendencias (√öltimos 30 d√≠as)</h2>
                    <div class="chart-container">
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>

                <!-- Distribuci√≥n por Tienda -->
                <div class="chart-card">
                    <h2>üè™ Compras por Tienda</h2>
                    <div class="chart-container">
                        <canvas id="storeChart"></canvas>
                    </div>
                </div>

                <!-- An√°lisis de Precios por Categor√≠a -->
                <div class="chart-card">
                    <h2>üí∞ Valor por Categor√≠a</h2>
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://plataforma-nowaste.onrender.com/api';
        let authToken = null;
        let currentUser = null;

        // Verificar autenticaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            authToken = localStorage.getItem('freshkeep_token');
            const userDataString = localStorage.getItem('freshkeep_user');
            
            if (!authToken || !userDataString) {
                window.location.replace('login.html');
                return;
            }
            
            currentUser = JSON.parse(userDataString);
            loadDashboard();
        });

        async function loadDashboard() {
            try {
                const response = await fetch(`${API_URL}/analytics/dashboard?days_back=30`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('freshkeep_token');
                    localStorage.removeItem('freshkeep_user');
                    window.location.replace('login.html');
                    return;
                }

                if (!response.ok) {
                    throw new Error('Error al cargar dashboard');
                }

                const data = await response.json();
                console.log('Dashboard data:', data);

                // Ocultar loading, mostrar dashboard
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

                // Actualizar estad√≠sticas
                updateStats(data.overview);

                // Mostrar productos pr√≥ximos a caducar
                displayExpiringProducts(data.expiring_products);

                // Crear gr√°ficos
                createCategoryChart(data.category_distribution);
                createLocationChart(data.location_distribution);
                createTrendsChart(data.daily_trends);
                createStoreChart(data.store_distribution);
                createPriceChart(data.price_analysis.price_per_category);

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').style.display = 'none';
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = '‚ùå Error al cargar el dashboard: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        function updateStats(overview) {
            document.getElementById('totalProducts').textContent = overview.total_products;
            document.getElementById('totalValue').textContent = overview.total_value.toFixed(2) + '‚Ç¨';
            document.getElementById('expiringSoon').textContent = overview.expiring_soon;
            document.getElementById('expired').textContent = overview.expired;
            document.getElementById('consumed').textContent = overview.consumed_last_30d;
            document.getElementById('wasteRate').textContent = overview.waste_rate.toFixed(1) + '%';
        }

        function displayExpiringProducts(products) {
            const container = document.getElementById('expiringProducts');
            
            if (products.length === 0) {
                container.innerHTML = '<div class="empty-state">üéâ ¬°No hay productos pr√≥ximos a caducar!</div>';
                return;
            }

            container.innerHTML = products.map(product => {
                const isCritical = product.days_until_expiration <= 2;
                const badgeClass = isCritical ? 'badge-danger' : 'badge-warning';
                const itemClass = isCritical ? 'critical' : '';
                
                return `
                    <div class="expiring-item ${itemClass}">
                        <div>
                            <h3>${product.name}</h3>
                            <p>
                                <span class="badge ${badgeClass}">${product.days_until_expiration} d√≠as</span>
                                ${product.quantity} ${product.unit} ‚Ä¢ ${product.location}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function createCategoryChart(data) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            const categoryNames = {
                'fruits': 'üçé Frutas',
                'vegetables': 'ü•ï Verduras',
                'dairy': 'ü•õ L√°cteos',
                'meat': 'ü•© Carnes',
                'fish': 'üêü Pescado',
                'grains': 'üçù Cereales',
                'beverages': 'ü•§ Bebidas',
                'snacks': 'üçø Snacks',
                'condiments': 'üßÇ Condimentos',
                'frozen': '‚ùÑÔ∏è Congelados',
                'bakery': 'üçû Panader√≠a',
                'other': 'üì¶ Otros'
            };

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.map(item => categoryNames[item.category] || item.category),
                    datasets: [{
                        data: data.map(item => item.count),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                            '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createLocationChart(data) {
            const ctx = document.getElementById('locationChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => item.location),
                    datasets: [{
                        data: data.map(item => item.count),
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createTrendsChart(data) {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => item.date),
                    datasets: [
                        {
                            label: 'Productos Agregados',
                            data: data.map(item => item.added),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Productos Consumidos',
                            data: data.map(item => item.consumed),
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function createStoreChart(data) {
            const ctx = document.getElementById('storeChart').getContext('2d');
            
            if (data.length === 0) {
                ctx.canvas.parentElement.innerHTML = '<div class="empty-state">No hay datos de tiendas</div>';
                return;
            }

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item.store),
                    datasets: [{
                        label: 'Gasto Total (‚Ç¨)',
                        data: data.map(item => item.total_spent),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createPriceChart(data) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (data.length === 0) {
                ctx.canvas.parentElement.innerHTML = '<div class="empty-state">No hay datos de precios</div>';
                return;
            }

            const categoryNames = {
                'fruits': 'üçé Frutas',
                'vegetables': 'ü•ï Verduras',
                'dairy': 'ü•õ L√°cteos',
                'meat': 'ü•© Carnes',
                'fish': 'üêü Pescado',
                'grains': 'üçù Cereales',
                'beverages': 'ü•§ Bebidas',
                'snacks': 'üçø Snacks',
                'condiments': 'üßÇ Condimentos',
                'frozen': '‚ùÑÔ∏è Congelados',
                'bakery': 'üçû Panader√≠a',
                'other': 'üì¶ Otros'
            };

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => categoryNames[item.category] || item.category),
                    datasets: [{
                        label: 'Valor Total (‚Ç¨)',
                        data: data.map(item => item.total_value),
                        backgroundColor: '#764ba2'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function logout() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                localStorage.removeItem('freshkeep_token');
                localStorage.removeItem('freshkeep_user');
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>