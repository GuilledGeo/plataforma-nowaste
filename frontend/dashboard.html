<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreshTrack - Anal√≠ticas Avanzadas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            /* Verde Oliva - Paleta Principal */
            --olive-50: #f7f8f3;
            --olive-100: #e8ecd9;
            --olive-200: #d4dbb8;
            --olive-300: #b8c48e;
            --olive-400: #9dad6b;
            --olive-500: #7d924a;
            --olive-600: #657a3a;
            --olive-700: #4d5c2e;
            --olive-800: #3a4623;
            --olive-900: #2a331a;
            
            /* Grises neutros */
            --gray-50: #fafafa;
            --gray-100: #f4f4f5;
            --gray-200: #e4e4e7;
            --gray-300: #d4d4d8;
            --gray-400: #a1a1aa;
            --gray-500: #71717a;
            --gray-600: #52525b;
            --gray-700: #3f3f46;
            --gray-800: #27272a;
            --gray-900: #18181b;
            
            /* Colores funcionales */
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            
            /* Sombras */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* ========== NAVBAR ========== */
        .navbar {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
            background: rgba(255, 255, 255, 0.95);
        }

        .nav-container {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            color: var(--olive-700);
            text-decoration: none;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--olive-500), var(--olive-600));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .nav-link {
            color: var(--gray-600);
            text-decoration: none;
            font-weight: 500;
            font-size: 15px;
            transition: color 0.2s;
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }

        .nav-link:hover {
            color: var(--olive-700);
            background: var(--olive-50);
        }

        .nav-link.active {
            color: var(--olive-700);
            background: var(--olive-50);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--olive-400), var(--olive-600));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        /* ========== MAIN CONTENT ========== */
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* ========== HERO SECTION ========== */
        .page-header {
            margin-bottom: 3rem;
        }

        .page-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .page-title h1 {
            font-size: 32px;
            font-weight: 700;
            color: var(--gray-900);
            letter-spacing: -0.02em;
        }

        .page-subtitle {
            font-size: 16px;
            color: var(--gray-500);
            font-weight: 400;
        }

        .time-selector {
            display: flex;
            gap: 0.5rem;
            background: white;
            padding: 4px;
            border-radius: 10px;
            border: 1px solid var(--gray-200);
        }

        .time-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--gray-600);
            font-weight: 600;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-btn:hover {
            background: var(--gray-100);
        }

        .time-btn.active {
            background: linear-gradient(135deg, var(--olive-500), var(--olive-600));
            color: white;
        }

        /* ========== STATS GRID ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.75rem;
            border: 1px solid var(--gray-200);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--olive-500), var(--olive-400));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .stat-card:hover {
            border-color: var(--olive-300);
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-icon.green {
            background: linear-gradient(135deg, var(--olive-100), var(--olive-200));
            color: var(--olive-700);
        }

        .stat-icon.blue {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
        }

        .stat-icon.orange {
            background: linear-gradient(135deg, #fed7aa, #fdba74);
            color: #9a3412;
        }

        .stat-icon.red {
            background: linear-gradient(135deg, #fecaca, #fca5a5);
            color: #991b1b;
        }

        .stat-icon.purple {
            background: linear-gradient(135deg, #e9d5ff, #d8b4fe);
            color: #6b21a8;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .stat-trend.up {
            background: #dcfce7;
            color: #166534;
        }

        .stat-trend.down {
            background: #fee2e2;
            color: #991b1b;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
            letter-spacing: -0.02em;
        }

        .stat-label {
            font-size: 14px;
            color: var(--gray-500);
            font-weight: 500;
        }

        .stat-detail {
            font-size: 13px;
            color: var(--gray-400);
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--gray-100);
        }

        /* ========== CHARTS SECTION ========== */
        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid var(--gray-200);
            transition: all 0.3s;
        }

        .chart-card:hover {
            border-color: var(--olive-300);
            box-shadow: var(--shadow-md);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .chart-subtitle {
            font-size: 13px;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .chart-container.large {
            height: 400px;
        }

        /* ========== EXPIRING PRODUCTS ========== */
        .expiring-section {
            margin-bottom: 3rem;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 1.5rem;
            letter-spacing: -0.01em;
        }

        .expiring-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .expiring-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            border-left: 4px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .expiring-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }

        .expiring-card.critical {
            border-color: var(--danger);
            background: linear-gradient(90deg, #fef2f2 0%, white 100%);
        }

        .expiring-card.warning {
            border-color: var(--warning);
            background: linear-gradient(90deg, #fffbeb 0%, white 100%);
        }

        .expiring-info h4 {
            font-size: 15px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .expiring-info p {
            font-size: 13px;
            color: var(--gray-600);
        }

        .expiring-badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            white-space: nowrap;
        }

        .expiring-badge.critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .expiring-badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        /* ========== INSIGHTS GRID ========== */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .insight-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid var(--gray-200);
        }

        .insight-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 1.5rem;
        }

        .insight-icon {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .insight-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .insight-items {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .insight-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 10px;
        }

        .insight-item-label {
            font-size: 14px;
            color: var(--gray-700);
            font-weight: 500;
        }

        .insight-item-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .insight-item-sub {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 2px;
        }

        /* ========== LOADING ========== */
        .loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 4rem 2rem;
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--olive-500);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--gray-600);
            font-size: 16px;
            font-weight: 500;
        }

        /* ========== ERROR ========== */
        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 1.5rem;
            border-radius: 12px;
            margin: 2rem 0;
            text-align: center;
            font-weight: 500;
            border: 1px solid #fecaca;
        }

        /* ========== EMPTY STATE ========== */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray-400);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 1200px) {
            .charts-section {
                grid-template-columns: 1fr;
            }

            .insights-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }

            .page-header {
                margin-bottom: 2rem;
            }

            .page-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .expiring-grid {
                grid-template-columns: 1fr;
            }

            .nav-links {
                display: none;
            }

            .chart-container {
                height: 250px;
            }

            .chart-container.large {
                height: 300px;
            }
        }

        /* ========== CATEGORY ICONS ========== */
        .category-icon {
            font-size: 20px;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <div class="logo-icon">üåø</div>
                <span>FreshTrack</span>
            </a>
            
            <div class="nav-links">
                <a href="index.html" class="nav-link">Inicio</a>
                <a href="index.html" class="nav-link">Inventario</a>
                <a href="dashboard.html" class="nav-link active">Anal√≠ticas</a>
                <a href="#" class="nav-link">Recetas</a>
                <a href="#" class="nav-link">Configuraci√≥n</a>
            </div>

            <div class="user-menu">
                <div class="user-avatar" onclick="logout()" id="userAvatar" title="Cerrar sesi√≥n">G</div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p class="loading-text">Cargando tus anal√≠ticas...</p>
        </div>

        <!-- Error State -->
        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <!-- Dashboard Content -->
        <div id="dashboard" style="display: none;">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-title">
                    <div>
                        <h1>üìä Panel de Anal√≠ticas</h1>
                        <p class="page-subtitle">Vista completa del rendimiento de tu inventario</p>
                    </div>
                    <div class="time-selector">
                        <button class="time-btn" onclick="changePeriod(7)">7 d√≠as</button>
                        <button class="time-btn active" onclick="changePeriod(30)">30 d√≠as</button>
                        <button class="time-btn" onclick="changePeriod(90)">90 d√≠as</button>
                    </div>
                </div>
            </div>

            <!-- Main Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon green">üì¶</div>
                        <div class="stat-trend up">
                            <span>‚Üë</span>
                            <span id="productsTrend">0%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="totalProducts">0</div>
                    <div class="stat-label">Productos Activos</div>
                    <div class="stat-detail" id="productsDetail">En tu inventario ahora</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon blue">üí∞</div>
                        <div class="stat-trend up">
                            <span>‚Üë</span>
                            <span id="valueTrend">0%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="totalValue">‚Ç¨0.00</div>
                    <div class="stat-label">Valor del Inventario</div>
                    <div class="stat-detail" id="valueDetail">Valor total de productos activos</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon orange">‚ö†Ô∏è</div>
                        <div class="stat-trend down">
                            <span>‚Üì</span>
                            <span id="expiringTrend">0%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="expiringSoon">0</div>
                    <div class="stat-label">Pr√≥ximos a Caducar</div>
                    <div class="stat-detail">En los pr√≥ximos 7 d√≠as</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon red">üóëÔ∏è</div>
                        <div class="stat-trend down">
                            <span>‚Üì</span>
                            <span id="expiredTrend">0%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="expired">0</div>
                    <div class="stat-label">Productos Caducados</div>
                    <div class="stat-detail" id="expiredDetail">Marcados como desperdicio</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon green">‚úÖ</div>
                        <div class="stat-trend up">
                            <span>‚Üë</span>
                            <span id="consumedTrend">0%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="consumed">0</div>
                    <div class="stat-label">Productos Consumidos</div>
                    <div class="stat-detail">En los √∫ltimos 30 d√≠as</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon purple">üìä</div>
                        <div class="stat-trend" id="wasteRateTrend">
                            <span>‚Üì</span>
                            <span>2%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="wasteRate">0%</div>
                    <div class="stat-label">Tasa de Desperdicio</div>
                    <div class="stat-detail" id="wasteRateDetail">Del total de productos</div>
                </div>
            </div>

            <!-- Expiring Products Section -->
            <div class="expiring-section">
                <h2 class="section-title">‚ö†Ô∏è Productos que Requieren Atenci√≥n</h2>
                <div class="expiring-grid" id="expiringProducts">
                    <div class="empty-state">
                        <div class="empty-state-icon">üéâ</div>
                        <p>¬°Genial! No hay productos pr√≥ximos a caducar</p>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <!-- Trends Chart -->
                <div class="chart-card" style="grid-column: span 2;">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">üìà Tendencias de Inventario</h3>
                            <p class="chart-subtitle">Evoluci√≥n diaria de productos agregados y consumidos</p>
                        </div>
                    </div>
                    <div class="chart-container large">
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>

                <!-- Category Distribution -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">üè∑Ô∏è Por Categor√≠a</h3>
                            <p class="chart-subtitle">Distribuci√≥n de productos</p>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <!-- Location Distribution -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">üìç Por Ubicaci√≥n</h3>
                            <p class="chart-subtitle">D√≥nde est√°n tus productos</p>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="locationChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Insights Grid -->
            <div class="insights-grid">
                <!-- Store Distribution -->
                <div class="insight-card">
                    <div class="insight-header">
                        <div class="insight-icon" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe);">üè™</div>
                        <h3 class="insight-title">Compras por Tienda</h3>
                    </div>
                    <div class="insight-items" id="storeInsights">
                        <div class="empty-state">
                            <p style="font-size: 14px;">Sin datos de tiendas</p>
                        </div>
                    </div>
                </div>

                <!-- Price Analysis -->
                <div class="insight-card">
                    <div class="insight-header">
                        <div class="insight-icon" style="background: linear-gradient(135deg, var(--olive-100), var(--olive-200)); color: var(--olive-700);">üíµ</div>
                        <h3 class="insight-title">Valor por Categor√≠a</h3>
                    </div>
                    <div class="insight-items" id="priceInsights">
                        <div class="empty-state">
                            <p style="font-size: 14px;">Sin datos de precios</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Summary -->
            <div class="insight-card" style="margin-bottom: 2rem;">
                <div class="insight-header">
                    <div class="insight-icon" style="background: linear-gradient(135deg, #fed7aa, #fdba74); color: #9a3412;">üí∞</div>
                    <h3 class="insight-title">Resumen Financiero</h3>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div class="insight-item">
                        <div>
                            <div class="insight-item-label">Gastado Total</div>
                            <div class="insight-item-sub" id="totalSpentPeriod">√öltimos 30 d√≠as</div>
                        </div>
                        <div class="insight-item-value" id="totalSpent">‚Ç¨0.00</div>
                    </div>
                    <div class="insight-item">
                        <div>
                            <div class="insight-item-label">Dinero Desperdiciado</div>
                            <div class="insight-item-sub" id="wastedMoneyPeriod">√öltimos 30 d√≠as</div>
                        </div>
                        <div class="insight-item-value" id="wastedMoney">‚Ç¨0.00</div>
                    </div>
                    <div class="insight-item">
                        <div>
                            <div class="insight-item-label">Tasa de Desperdicio</div>
                            <div class="insight-item-sub">Del gasto total</div>
                        </div>
                        <div class="insight-item-value" id="wasteRateFinancial">0%</div>
                    </div>
                    <div class="insight-item">
                        <div>
                            <div class="insight-item-label">Gasto Promedio/D√≠a</div>
                            <div class="insight-item-sub" id="avgDailyPeriod">√öltimos 30 d√≠as</div>
                        </div>
                        <div class="insight-item-value" id="avgDaily">‚Ç¨0.00</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_URL = 'https://plataforma-nowaste.onrender.com/api';
        let authToken = null;
        let currentUser = null;
        let currentPeriod = 30;
        let dashboardData = null;

        // Category names with emojis
        const categoryNames = {
            'fruits': 'üçé Frutas',
            'vegetables': 'ü•ï Verduras',
            'dairy': 'ü•õ L√°cteos',
            'meat': 'ü•© Carnes',
            'fish': 'üêü Pescado',
            'grains': 'üçù Cereales',
            'beverages': 'ü•§ Bebidas',
            'snacks': 'üçø Snacks',
            'condiments': 'üßÇ Condimentos',
            'frozen': '‚ùÑÔ∏è Congelados',
            'bakery': 'üçû Panader√≠a',
            'other': 'üì¶ Otros'
        };

        // Location names
        const locationNames = {
            'pantry': 'üóÑÔ∏è Despensa',
            'fridge': '‚ùÑÔ∏è Nevera',
            'freezer': 'üßä Congelador'
        };

        // ‚úÖ Initialize - CON VALIDACI√ìN DE SEGURIDAD
        document.addEventListener('DOMContentLoaded', () => {
            authToken = localStorage.getItem('freshkeep_token');
            const userDataString = localStorage.getItem('freshkeep_user');
            
            if (!authToken || !userDataString) {
                console.log('‚ùå No hay sesi√≥n activa');
                window.location.replace('login.html');
                return;
            }
            
            try {
                currentUser = JSON.parse(userDataString);
                document.getElementById('userAvatar').textContent = currentUser.full_name.charAt(0).toUpperCase();
                
                console.log('‚úÖ Dashboard para usuario:', currentUser.email, '(ID:', currentUser.id + ')');
                loadDashboard();
            } catch (error) {
                console.error('‚ùå Error al parsear usuario:', error);
                window.location.replace('login.html');
            }
        });

        async function loadDashboard() {
            try {
                showLoading();

                console.log(`üì° Solicitando analytics para user_id=${currentUser.id}, period=${currentPeriod} d√≠as`);

                const response = await fetch(`${API_URL}/analytics/dashboard?days_back=${currentPeriod}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.status === 401) {
                    console.error('‚ùå Token inv√°lido (401)');
                    localStorage.removeItem('freshkeep_token');
                    localStorage.removeItem('freshkeep_user');
                    window.location.replace('login.html');
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                dashboardData = await response.json();
                console.log('‚úÖ Datos recibidos:', dashboardData);

                hideLoading();
                updateDashboard(dashboardData);

            } catch (error) {
                console.error('‚ùå Error:', error);
                hideLoading();
                showError('‚ùå Error al cargar dashboard: ' + error.message);
            }
        }

        function updateDashboard(data) {
            console.log('üìä Actualizando dashboard para:', currentUser.email);
            updateStats(data);
            updateExpiringProducts(data.expiring_products || []);
            createCharts(data);
            updateInsights(data);
            updateFinancialSummary(data);
        }

        function updateStats(data) {
            // ‚úÖ USAR DATOS CORRECTOS DEL BACKEND
            const overview = data.overview || {};
            const productSummary = data.product_summary || {};
            const financialSummary = data.financial_summary || {};
            const waste = data.waste_metrics || {};

            console.log('üìä Overview:', overview);
            console.log('üì¶ Product Summary:', productSummary);
            console.log('üí∞ Financial Summary:', financialSummary);

            // Total Products (usar product_summary si existe, sino overview)
            const totalProducts = productSummary.active || overview.total_products || 0;
            document.getElementById('totalProducts').textContent = totalProducts;
            const totalFromData = productSummary.total || totalProducts;
            document.getElementById('productsDetail').textContent = `De ${totalFromData} productos totales`;

            // Total Value
            const totalValue = financialSummary.current_inventory_value || overview.total_value || 0;
            document.getElementById('totalValue').textContent = `‚Ç¨${totalValue.toFixed(2)}`;
            const avgPrice = totalProducts > 0 ? totalValue / totalProducts : 0;
            document.getElementById('valueDetail').textContent = `~‚Ç¨${avgPrice.toFixed(2)} promedio por producto`;

            // Expiring Soon
            const expiringSoon = productSummary.expiring_soon_7days || overview.expiring_soon || 0;
            document.getElementById('expiringSoon').textContent = expiringSoon;
            
            // Expired
            const expired = productSummary.expired || overview.expired || 0;
            document.getElementById('expired').textContent = expired;
            const wastedMoney = financialSummary.money_wasted || 0;
            if (wastedMoney > 0) {
                document.getElementById('expiredDetail').textContent = `‚Ç¨${wastedMoney.toFixed(2)} en desperdicio`;
            } else {
                document.getElementById('expiredDetail').textContent = `Marcados como desperdicio`;
            }

            // Consumed
            const consumed = productSummary.consumed || overview.consumed_last_30d || 0;
            document.getElementById('consumed').textContent = consumed;

            // Waste Rate
            const wasteRate = waste.waste_percentage || overview.waste_rate || 0;
            document.getElementById('wasteRate').textContent = `${wasteRate.toFixed(1)}%`;
            document.getElementById('wasteRateDetail').textContent = `${waste.total_wasted || 0} de ${waste.total_products || 0} productos`;

            // Update trends (simulados por ahora)
            document.getElementById('productsTrend').textContent = '5%';
            document.getElementById('valueTrend').textContent = '12%';
            document.getElementById('expiringTrend').textContent = '8%';
            document.getElementById('expiredTrend').textContent = '15%';
            document.getElementById('consumedTrend').textContent = '20%';
            
            const wasteTrendEl = document.getElementById('wasteRateTrend');
            if (wasteRate > 10) {
                wasteTrendEl.innerHTML = '<span>‚Üë</span><span>2%</span>';
                wasteTrendEl.className = 'stat-trend up';
            } else {
                wasteTrendEl.innerHTML = '<span>‚Üì</span><span>2%</span>';
                wasteTrendEl.className = 'stat-trend down';
            }

            console.log('‚úÖ Estad√≠sticas actualizadas');
        }

        function updateExpiringProducts(products) {
            const container = document.getElementById('expiringProducts');
            
            if (!products || products.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéâ</div>
                        <p>¬°Genial! No hay productos pr√≥ximos a caducar</p>
                    </div>
                `;
                return;
            }

            console.log(`üìã Mostrando ${products.length} productos pr√≥ximos a caducar`);

            container.innerHTML = products.map(product => {
                const isCritical = product.days_until_expiration <= 2;
                const cardClass = isCritical ? 'critical' : 'warning';
                const badgeClass = isCritical ? 'critical' : 'warning';
                
                return `
                    <div class="expiring-card ${cardClass}">
                        <div class="expiring-info">
                            <h4>${product.name}</h4>
                            <p>
                                <span class="category-icon">${getCategoryIcon(product.category)}</span>
                                ${product.quantity} ${product.unit} ‚Ä¢ ${locationNames[product.location] || product.location}
                            </p>
                        </div>
                        <div class="expiring-badge ${badgeClass}">
                            ${product.days_until_expiration} d√≠as
                        </div>
                    </div>
                `;
            }).join('');
        }

        function createCharts(data) {
            createTrendsChart(data.daily_trends || []);
            createCategoryChart(data.category_distribution || []);
            createLocationChart(data.location_distribution || []);
        }

        function createTrendsChart(trends) {
            if (!trends || trends.length === 0) {
                console.log('‚ö†Ô∏è No hay datos de tendencias');
                return;
            }

            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            const existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trends.map(item => {
                        const date = new Date(item.date);
                        return date.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
                    }),
                    datasets: [
                        {
                            label: 'Productos Agregados',
                            data: trends.map(item => item.added || 0),
                            borderColor: '#7d924a',
                            backgroundColor: 'rgba(125, 146, 74, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Productos Consumidos',
                            data: trends.map(item => item.consumed || 0),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 13,
                                    weight: '600'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: '600'
                            },
                            bodyFont: {
                                size: 13
                            },
                            borderColor: '#e4e4e7',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: '#f4f4f5'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function createCategoryChart(data) {
            if (!data || data.length === 0) {
                console.log('‚ö†Ô∏è No hay datos de categor√≠as');
                return;
            }

            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            const existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }

            const colors = [
                '#7d924a', '#9dad6b', '#b8c48e', '#3b82f6',
                '#ef4444', '#f59e0b', '#10b981', '#8b5cf6',
                '#ec4899', '#14b8a6', '#f97316', '#6366f1'
            ];

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => categoryNames[item.category] || item.category),
                    datasets: [{
                        data: data.map(item => item.count || 0),
                        backgroundColor: colors,
                        borderWidth: 0,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 12,
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: '600'
                            },
                            bodyFont: {
                                size: 13
                            }
                        }
                    }
                }
            });
        }

        function createLocationChart(data) {
            if (!data || data.length === 0) {
                console.log('‚ö†Ô∏è No hay datos de ubicaciones');
                return;
            }

            const ctx = document.getElementById('locationChart').getContext('2d');
            
            const existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => locationNames[item.location] || item.location),
                    datasets: [{
                        data: data.map(item => item.count || 0),
                        backgroundColor: ['#7d924a', '#3b82f6', '#8b5cf6'],
                        borderWidth: 0,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 12,
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: '600'
                            },
                            bodyFont: {
                                size: 13
                            }
                        }
                    }
                }
            });
        }

        function updateInsights(data) {
            updateStoreInsights(data.store_distribution || []);
            updatePriceInsights(data.price_analysis?.price_per_category || []);
        }

        function updateStoreInsights(stores) {
            const container = document.getElementById('storeInsights');
            
            if (!stores || stores.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="font-size: 14px;">Sin datos de tiendas</p>
                    </div>
                `;
                return;
            }

            const topStores = stores.sort((a, b) => (b.total_spent || 0) - (a.total_spent || 0)).slice(0, 5);

            container.innerHTML = topStores.map(store => `
                <div class="insight-item">
                    <div>
                        <div class="insight-item-label">${store.store || 'Sin especificar'}</div>
                        <div class="insight-item-sub">${store.product_count || store.count || 0} productos</div>
                    </div>
                    <div class="insight-item-value">‚Ç¨${(store.total_spent || 0).toFixed(2)}</div>
                </div>
            `).join('');
        }

        function updatePriceInsights(priceData) {
            const container = document.getElementById('priceInsights');
            
            if (!priceData || priceData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="font-size: 14px;">Sin datos de precios</p>
                    </div>
                `;
                return;
            }

            const topCategories = priceData.sort((a, b) => (b.total_value || 0) - (a.total_value || 0)).slice(0, 5);

            container.innerHTML = topCategories.map(cat => `
                <div class="insight-item">
                    <div>
                        <div class="insight-item-label">${categoryNames[cat.category] || cat.category}</div>
                        <div class="insight-item-sub">${cat.product_count || 0} productos</div>
                    </div>
                    <div class="insight-item-value">‚Ç¨${(cat.total_value || 0).toFixed(2)}</div>
                </div>
            `).join('');
        }

        function updateFinancialSummary(data) {
            const financial = data.financial_summary || {};
            
            document.getElementById('totalSpent').textContent = `‚Ç¨${(financial.total_spent || 0).toFixed(2)}`;
            document.getElementById('wastedMoney').textContent = `‚Ç¨${(financial.money_wasted || 0).toFixed(2)}`;
            document.getElementById('wasteRateFinancial').textContent = `${(financial.waste_rate_percentage || 0).toFixed(1)}%`;
            
            const avgDaily = financial.avg_daily_spending || (financial.total_spent ? financial.total_spent / currentPeriod : 0);
            document.getElementById('avgDaily').textContent = `‚Ç¨${avgDaily.toFixed(2)}`;

            const periodText = currentPeriod === 7 ? '7 d√≠as' : currentPeriod === 30 ? '30 d√≠as' : '90 d√≠as';
            document.getElementById('totalSpentPeriod').textContent = `√öltimos ${periodText}`;
            document.getElementById('wastedMoneyPeriod').textContent = `√öltimos ${periodText}`;
            document.getElementById('avgDailyPeriod').textContent = `√öltimos ${periodText}`;
        }

        function getCategoryIcon(category) {
            const icons = {
                'fruits': 'üçé',
                'vegetables': 'ü•ï',
                'dairy': 'ü•õ',
                'meat': 'ü•©',
                'fish': 'üêü',
                'grains': 'üçù',
                'beverages': 'ü•§',
                'snacks': 'üçø',
                'condiments': 'üßÇ',
                'frozen': '‚ùÑÔ∏è',
                'bakery': 'üçû',
                'other': 'üì¶'
            };
            return icons[category] || 'üì¶';
        }

        function changePeriod(days) {
            currentPeriod = days;
            
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            console.log(`‚è±Ô∏è Cambiando a periodo de ${days} d√≠as`);
            loadDashboard();
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        function logout() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                console.log('üëã Cerrando sesi√≥n de:', currentUser.email);
                localStorage.removeItem('freshkeep_token');
                localStorage.removeItem('freshkeep_user');
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>